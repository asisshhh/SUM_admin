// This file contains the code that needs to be added to AppointmentOrders.jsx

// 1. Add onReschedule to AppointmentTable call (around line 356):
onReschedule={handleReschedule}

// 2. Add RescheduleAppointmentModal component after OrderDetailsModal (around line 379):

      {/* Reschedule Modal */}
      {rescheduleModalOpen && selectedAppointment && (
        <RescheduleAppointmentModal
          appointment={selectedAppointment}
          departments={departments}
          onClose={() => {
            setRescheduleModalOpen(false);
            setSelectedAppointment(null);
          }}
          onSuccess={() => {
            load(page);
            setRescheduleModalOpen(false);
            setSelectedAppointment(null);
          }}
        />
      )}
    </div>
  );
}

// 3. Add the RescheduleAppointmentModal component function before the export default (after line 296):

// Reschedule Appointment Modal Component
function RescheduleAppointmentModal({ appointment, departments, onClose, onSuccess }) {
  const [formData, setFormData] = useState({
    date: "",
    timeSlot: "",
    doctorId: "",
    departmentId: appointment?.departmentId?.toString() || "",
    notes: ""
  });
  const [errors, setErrors] = useState({});
  const [availableDoctors, setAvailableDoctors] = useState([]);
  const [availableSlots, setAvailableSlots] = useState([]);
  const [loadingDoctors, setLoadingDoctors] = useState(false);
  const [loadingSlots, setLoadingSlots] = useState(false);

  // Reset form when appointment changes
  useEffect(() => {
    if (appointment?.id) {
      setFormData({
        date: "",
        timeSlot: "",
        doctorId: appointment?.doctorId?.toString() || "",
        departmentId: appointment?.departmentId?.toString() || "",
        notes: ""
      });
      setErrors({});
      setAvailableDoctors([]);
      setAvailableSlots([]);
      // Load doctors for current department
      if (appointment?.departmentId) {
        loadDoctors(appointment.departmentId.toString());
      }
    }
  }, [appointment?.id]);

  // Load doctors when department changes
  const loadDoctors = async (deptId) => {
    if (!deptId) {
      setAvailableDoctors([]);
      setFormData((prev) => ({ ...prev, doctorId: "", timeSlot: "" }));
      setAvailableSlots([]);
      return;
    }
    setLoadingDoctors(true);
    try {
      const res = await api.get("/doctors", { params: { departmentId: deptId, pageSize: 100 } });
      const list = Array.isArray(res.data) ? res.data : res.data?.items || res.data?.doctors || [];
      setAvailableDoctors(list);
      // If current doctor is in the new department list, keep it selected
      if (appointment?.doctorId && list.find(d => d.id === appointment.doctorId)) {
        setFormData((prev) => ({ ...prev, doctorId: appointment.doctorId.toString() }));
      } else {
        setFormData((prev) => ({ ...prev, doctorId: "", timeSlot: "" }));
        setAvailableSlots([]);
      }
    } catch (err) {
      console.error("Failed to load doctors:", err);
      toast.error("Failed to load doctors");
      setAvailableDoctors([]);
    } finally {
      setLoadingDoctors(false);
    }
  };

  // Fetch available slots when doctor and date are selected
  useEffect(() => {
    if (!formData.doctorId || !formData.date) {
      setAvailableSlots([]);
      setFormData((prev) => ({ ...prev, timeSlot: "" }));
      return;
    }

    setLoadingSlots(true);
    api
      .get(`/schedule/${formData.doctorId}/slots`, {
        params: { date: formData.date }
      })
      .then((res) => {
        const slots = res.data?.slots || res.data || [];
        const available = Array.isArray(slots) ? slots.filter((slot) => slot.status === "AVAILABLE") : [];
        setAvailableSlots(available);
      })
      .catch((err) => {
        console.error("Failed to load slots:", err);
        toast.error("Failed to load available slots");
        setAvailableSlots([]);
      })
      .finally(() => setLoadingSlots(false));
  }, [formData.doctorId, formData.date]);

  const validate = () => {
    const newErrors = {};
    if (!formData.date) newErrors.date = "Date is required";
    if (!formData.doctorId) newErrors.doctorId = "Doctor is required";
    if (!formData.timeSlot) newErrors.timeSlot = "Time slot is required";
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const rescheduleMutation = useMutation({
    mutationFn: async () => {
      if (!appointment?.id) {
        throw new Error("Appointment ID is missing");
      }
      const payload = {
        date: formData.date,
        timeSlot: formData.timeSlot,
        doctorId: Number(formData.doctorId),
        notes: formData.notes || undefined
      };
      const url = `/appointments/${appointment.id}/reschedule`;
      const response = await api.put(url, payload);
      return response.data;
    },
    onSuccess: () => {
      toast.success("Appointment rescheduled successfully");
      onSuccess();
    },
    onError: (err) => {
      const errorMsg = err.response?.data?.error || err.response?.data?.message || err.message || "Failed to reschedule appointment";
      toast.error(errorMsg);
    }
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!validate()) return;
    rescheduleMutation.mutate();
  };

  const handleChange = (field, value) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    if (errors[field]) setErrors((prev) => ({ ...prev, [field]: undefined }));
    
    // If department changes, reload doctors
    if (field === "departmentId") {
      loadDoctors(value);
    }
    
    // If doctor changes, clear time slot
    if (field === "doctorId") {
      setFormData((prev) => ({ ...prev, timeSlot: "" }));
      setAvailableSlots([]);
    }
  };

  const currentDate = appointment?.date ? new Date(appointment.date).toLocaleDateString("en-IN") : "N/A";
  const currentTime = appointment?.timeSlot || "N/A";
  const currentDoctor = appointment?.doctor?.user?.name || "N/A";
  const currentDepartment = appointment?.department?.name || "N/A";

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-gradient-to-r from-orange-600 to-amber-600">
          <h2 className="text-lg font-semibold text-white">Reschedule Appointment</h2>
          <button
            onClick={onClose}
            className="p-1 hover:bg-white/20 rounded-lg transition">
            <X size={20} className="text-white" />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-6 space-y-4 overflow-y-auto flex-1">
          {/* Current Appointment Info */}
          {appointment && (
            <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
              <div className="text-sm font-medium text-slate-700 mb-2">
                Current Appointment
              </div>
              <div className="grid grid-cols-2 gap-3 text-sm text-slate-600">
                <div className="flex items-center gap-2">
                  <Calendar size={14} className="text-slate-400" />
                  <span>Date: {currentDate}</span>
                </div>
                <div className="flex items-center gap-2">
                  <Clock size={14} className="text-slate-400" />
                  <span>Time: {currentTime}</span>
                </div>
                <div className="flex items-center gap-2">
                  <Building2 size={14} className="text-slate-400" />
                  <span>Dept: {currentDepartment}</span>
                </div>
                <div className="flex items-center gap-2">
                  <Stethoscope size={14} className="text-slate-400" />
                  <span>Doctor: {currentDoctor}</span>
                </div>
              </div>
            </div>
          )}

          {/* New Department */}
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">
              Department *
            </label>
            <SearchableDropdown
              value={formData.departmentId || ""}
              options={[
                { value: "", label: "Select Department" },
                ...departments.map((dept) => ({
                  value: dept.id.toString(),
                  label: dept.name
                }))
              ]}
              onChange={(value) => handleChange("departmentId", value)}
              placeholder="Select Department"
              disabled={loadingDoctors}
            />
            {errors.departmentId && (
              <p className="text-red-500 text-xs mt-1">{errors.departmentId}</p>
            )}
          </div>

          {/* New Doctor */}
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">
              Doctor *
            </label>
            {loadingDoctors ? (
              <div className="flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg">
                <Loader2 className="animate-spin text-orange-600" size={16} />
                <span className="text-sm text-slate-600">Loading doctors...</span>
              </div>
            ) : (
              <SearchableDropdown
                value={formData.doctorId || ""}
                options={[
                  { value: "", label: "Select Doctor" },
                  ...availableDoctors.map((doc) => ({
                    value: doc.id.toString(),
                    label: doc.user?.name || doc.name || `Doctor ${doc.id}`
                  }))
                ]}
                onChange={(value) => handleChange("doctorId", value)}
                placeholder="Select Doctor"
                disabled={!formData.departmentId || availableDoctors.length === 0}
              />
            )}
            {errors.doctorId && (
              <p className="text-red-500 text-xs mt-1">{errors.doctorId}</p>
            )}
          </div>

          {/* New Date */}
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">
              New Date *
            </label>
            <input
              type="date"
              value={formData.date}
              onChange={(e) => handleChange("date", e.target.value)}
              className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent ${
                errors.date ? "border-red-500" : "border-slate-300"
              }`}
            />
            {errors.date && (
              <p className="text-red-500 text-xs mt-1">{errors.date}</p>
            )}
          </div>

          {/* New Time Slot */}
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">
              New Time Slot *
            </label>
            {loadingSlots ? (
              <div className="flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg">
                <Loader2 className="animate-spin text-orange-600" size={16} />
                <span className="text-sm text-slate-600">Loading available slots...</span>
              </div>
            ) : availableSlots.length === 0 && formData.date && formData.doctorId ? (
              <div className="px-4 py-2 border border-yellow-300 bg-yellow-50 rounded-lg text-sm text-yellow-700">
                No available slots for this date. Please select another date or doctor.
              </div>
            ) : (
              <SearchableDropdown
                value={formData.timeSlot || ""}
                options={[
                  { value: "", label: "Select Time Slot" },
                  ...availableSlots.map((slot) => ({
                    value: slot.time,
                    label: slot.time
                  }))
                ]}
                onChange={(value) => handleChange("timeSlot", value)}
                placeholder="Select Time Slot"
                disabled={!formData.date || !formData.doctorId || availableSlots.length === 0}
              />
            )}
            {errors.timeSlot && (
              <p className="text-red-500 text-xs mt-1">{errors.timeSlot}</p>
            )}
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">
              Notes (Optional)
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => handleChange("notes", e.target.value)}
              rows={3}
              placeholder="Add any additional notes (e.g., doctor unavailability, patient request)..."
              className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"
            />
          </div>

          {/* Actions */}
          <div className="flex gap-3 pt-4 border-t border-slate-200">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition">
              Cancel
            </button>
            <button
              type="submit"
              disabled={rescheduleMutation.isPending}
              className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition disabled:opacity-50 flex items-center justify-center gap-2">
              {rescheduleMutation.isPending ? (
                <>
                  <Loader2 className="animate-spin" size={16} />
                  Rescheduling...
                </>
              ) : (
                "Reschedule"
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

